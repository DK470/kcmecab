<!doctype html>
<html>
    <head>
        <script type="module">
            import Mecab from "https://unpkg.com/mecab-wasm@1.0.3/lib/mecab.js";

            async function initializeMecab() {
                try {
                    await Mecab.waitReady();
                    console.log("MeCab is ready.");
                } catch (error) {
                    console.error("Error initializing MeCab:", error);
                    alert("Failed to initialize MeCab.");
                }
            }

            async function handleQuery() {
                const params = new URLSearchParams(window.location.search);
                const inputText = params.get("text");

                if (inputText) {
                    try {
                        const response = await fetch(`https://dk470.github.io/kcmecab/mecab.html?text=${encodeURIComponent(inputText)}`);
                        const htmlText = await response.text();
                        const result = parseMecabHtmlResponse(htmlText);  // Extract MeCab results from HTML
                        console.log("MeCab query result:", result);
                        document.body.innerHTML = JSON.stringify(result);
                    } catch (error) {
                        document.body.innerHTML = "Error querying MeCab: " + error.message;
                    }
                } else {
                    document.body.innerHTML = JSON.stringify({ error: "No text provided" });
                }
            }

            function parseMecabHtmlResponse(htmlText) {
                // Extract MeCab results from HTML and return as a JSON object
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;

                try {
                    // Parse the body content (which is a JSON string) and convert it into an object
                    const jsonResponse = JSON.parse(tempDiv.textContent.trim());
                    return jsonResponse;
                } catch (e) {
                    console.error("Failed to parse MeCab response:", e);
                    return { error: "Failed to parse MeCab results" };
                }
            }

            window.addEventListener("load", initializeMecab);
        </script>
    </head>
    <body>
        <!-- Your content here -->
    </body>
</html>
